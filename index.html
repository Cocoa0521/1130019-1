<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>記憶配對遊戲</title>
    <style>
        /* --- 整體頁面樣式 --- */
        :root {
            --card-size: clamp(60px, 18vw, 100px); /* 卡片大小，可適應不同螢幕 */
            --grid-gap: 15px;
            --primary-color: #3a9bff; /* 調整為亮藍色以增加對比度 */
            --background-color: #121212; /* 將背景改為黑色 */
            --card-color: #1e1e1e; /* 將容器改為深灰色 */
            --card-matched-color: #2e4f34; /* 配對成功的深綠色 */
            --font-color: #e0e0e0; /* 將字體改為淺灰色 */
            --border-radius: 12px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--background-color);
            margin: 0;
            box-sizing: border-box;
        }

        /* --- 遊戲主容器 --- */
        .game-container {
            text-align: center;
            background-color: var(--card-color);
            padding: clamp(15px, 5vw, 30px);
            width: 100vw; /* 設定寬度為100%視窗寬度 */
            min-height: 100vh; /* 設定最小高度為100%視窗高度 */
            display: flex; /* 使用 Flexbox 來置中內容 */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-sizing: border-box; /* 確保 padding 不會影響整體尺寸 */
        }

        h1 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 20px;
            font-size: clamp(1.8rem, 6vw, 2.5rem);
        }

        /* --- 設定區塊 --- */
        .settings {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .settings div {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings label {
            color: var(--font-color);
            font-weight: 500;
        }

        .settings select {
            padding: 5px 8px;
            border-radius: 6px;
            border: 1px solid #444;
            background-color: #333;
            color: var(--font-color);
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .settings select:hover {
            background-color: #444;
        }

        .settings select:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* --- 遊戲資訊 (步數, 時間) --- */
        .stats {
            display: flex;
            justify-content: space-around;
            width: 100%;
            max-width: 400px;
            margin-bottom: 20px;
            font-size: clamp(1rem, 4vw, 1.2rem);
            color: var(--font-color);
            font-weight: 500;
        }

        /* --- 遊戲面板 --- */
        .game-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--grid-gap);
            perspective: 1000px;
            margin: 0 auto 20px;
            width: 100%;
            max-width: 800px;
        }

        /* --- 卡牌樣式 --- */
        .card {
            width: var(--card-size);
            height: var(--card-size);
            position: relative;
            cursor: pointer;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            aspect-ratio: 1 / 1;
        }

        .card.flipped {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: var(--border-radius);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: clamp(2rem, 10vw, 3.5rem);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .card-front {
            background: linear-gradient(135deg, #89cff0, #4682b4);
            color: white;
        }

        .card-back {
            background-color: var(--card-color);
            transform: rotateY(180deg);
        }
        
        .card.matched .card-back {
            background-color: var(--card-matched-color);
            box-shadow: 0 0 10px #28a745;
            animation: pulse 0.5s;
        }
        
        @keyframes pulse {
            0% { transform: rotateY(180deg) scale(1); }
            50% { transform: rotateY(180deg) scale(1.1); }
            100% { transform: rotateY(180deg) scale(1); }
        }

        /* --- 按鈕區塊 --- */
        .actions {
            display: flex;
            gap: 15px;
        }

        /* --- 按鈕樣式 --- */
        .btn {
            padding: 12px 25px;
            font-size: clamp(1rem, 4vw, 1.1rem);
            color: white;
            background-color: var(--primary-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }

        .btn:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }
        
        .btn.secondary {
            background-color: #6c757d;
        }
        .btn.secondary:hover {
             background-color: #5a6268;
        }


        /* --- 彈出視窗 --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #2a2a2a;
            margin: auto;
            padding: 20px 30px;
            border: 1px solid #444;
            width: 90%;
            max-width: 500px;
            border-radius: var(--border-radius);
            text-align: center;
            animation: slide-down 0.5s ease-out;
        }
        
        @keyframes slide-down {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-content h2 { color: var(--primary-color); }
        .modal-content p { color: var(--font-color); }
        
        /* 輸入框樣式 */
        .modal-content input {
            width: 80%;
            padding: 10px;
            margin: 15px 0;
            border-radius: 6px;
            border: 1px solid #555;
            background-color: #333;
            color: var(--font-color);
            font-size: 1rem;
        }

        /* 排行榜表格 */
        #leaderboard-table {
            width: 100%;
            margin-top: 15px;
            border-collapse: collapse;
        }
        #leaderboard-table th, #leaderboard-table td {
            padding: 10px;
            border-bottom: 1px solid #444;
            color: var(--font-color);
        }
        #leaderboard-table th {
            color: var(--primary-color);
        }
        #leaderboard-table tr:last-child td {
            border-bottom: none;
        }

    </style>
</head>
<body>

    <div class="game-container">
        <h1>記憶配對遊戲</h1>
        <div class="settings">
            <div>
                <label for="difficulty-select">難度:</label>
                <select id="difficulty-select">
                    <option value="easy">簡單 (4x2)</option>
                    <option value="medium" selected>中等 (4x4)</option>
                    <option value="hard">困難 (6x4)</option>
                </select>
            </div>
            <div>
                <label for="theme-select">主題:</label>
                <select id="theme-select">
                    <option value="animals" selected>動物</option>
                    <option value="fruits">水果</option>
                    <option value="food">食物</option>
                    <option value="vehicles">交通工具</option>
                </select>
            </div>
            <div>
                <label for="timer-select">計時:</label>
                <select id="timer-select">
                    <option value="unlimited" selected>無限</option>
                    <option value="30">30秒</option>
                    <option value="60">60秒</option>
                    <option value="90">90秒</option>
                </select>
            </div>
        </div>
        <div class="stats">
            <div id="moves-count">步數: 0</div>
            <div id="timer">時間: 0s</div>
        </div>
        <div class="game-board" id="game-board"></div>
        <div class="actions">
            <button class="btn" id="restart-btn">開始遊戲</button>
            <button class="btn secondary" id="leaderboard-btn">排行榜</button>
        </div>
    </div>

    <!-- 輸入名稱 Modal -->
    <div id="name-modal" class="modal">
        <div class="modal-content">
            <h2>恭喜獲勝！</h2>
            <p id="final-score-p"></p>
            <p>請輸入您的大名以記錄分數：</p>
            <input type="text" id="player-name-input" placeholder="玩家名稱" maxlength="10">
            <button class="btn" id="submit-score-btn">提交分數</button>
        </div>
    </div>
    
    <!-- 排行榜 Modal -->
    <div id="leaderboard-modal" class="modal">
        <div class="modal-content">
            <h2>排行榜 (Top 10)</h2>
            <table id="leaderboard-table">
                <thead>
                    <tr><th>排名</th><th>名稱</th><th>分數</th><th>難度</th></tr>
                </thead>
                <tbody id="leaderboard-body"></tbody>
            </table>
            <button class="btn" id="close-leaderboard-btn" style="margin-top: 20px;">關閉</button>
        </div>
    </div>

    <!-- 遊戲失敗 Modal -->
    <div id="lose-modal" class="modal">
        <div class="modal-content">
            <h2>時間到！</h2>
            <p>別灰心，再試一次吧！</p>
            <button class="btn" id="modal-try-again-btn">再試一次</button>
        </div>
    </div>


    <script>
        // --- DOM 元素獲取 ---
        const gameBoard = document.getElementById('game-board');
        const movesCountSpan = document.getElementById('moves-count');
        const timerSpan = document.getElementById('timer');
        const restartBtn = document.getElementById('restart-btn');
        const difficultySelect = document.getElementById('difficulty-select');
        const themeSelect = document.getElementById('theme-select');
        const timerSelect = document.getElementById('timer-select');

        // Modals
        const nameModal = document.getElementById('name-modal');
        const finalScoreP = document.getElementById('final-score-p');
        const playerNameInput = document.getElementById('player-name-input');
        const submitScoreBtn = document.getElementById('submit-score-btn');
        const leaderboardModal = document.getElementById('leaderboard-modal');
        const leaderboardBtn = document.getElementById('leaderboard-btn');
        const closeLeaderboardBtn = document.getElementById('close-leaderboard-btn');
        const leaderboardBody = document.getElementById('leaderboard-body');
        const loseModal = document.getElementById('lose-modal');
        const modalTryAgainBtn = document.getElementById('modal-try-again-btn');
        
        const LEADERBOARD_KEY = 'memoryGameLeaderboard';

        // --- 遊戲設定 ---
        const themes = {
            animals: ['🐶', '🐱', '🐭', '🐹', '🐰', '🦊', '🐻', '🐼', '🐨', '🐯', '🦁', '🐮'],
            fruits: ['🍎', '🍌', '🍇', '🍉', '🍓', '🍑', '🍍', '🥝', '🥭', '🥥', '🍒', '🍋'],
            food: ['🍕', '🍔', '🍟', '🌭', '🍿', '🍩', '🍪', '🍰', '🍣', '🌮', '🍦', '🥐'],
            vehicles: ['🚗', '🚕', '🚌', '🚓', '🚑', '🚒', '🚚', '🚜', '🚲', '🛵', '✈️', '🚀']
        };

        const difficultySettings = {
            easy: { pairs: 4, cols: 4, score: 1000 },
            medium: { pairs: 8, cols: 4, score: 2500 },
            hard: { pairs: 12, cols: 6, score: 5000 }
        };

        // --- 遊戲狀態變數 ---
        let cards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let moves = 0;
        let lockBoard = true;
        let gameActive = false;
        let timer;
        let seconds = 0;
        let isCountdown = false;
        let finalScore = 0;

        // --- 遊戲主要功能 ---

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        function prepareGame() {
            gameActive = false;
            lockBoard = true;
            restartBtn.textContent = '開始遊戲';
            [difficultySelect, themeSelect, timerSelect].forEach(sel => sel.disabled = false);
            clearInterval(timer);

            const difficulty = difficultySelect.value;
            const theme = themeSelect.value;
            const currentDifficulty = difficultySettings[difficulty];
            const currentThemeEmojis = themes[theme].slice(0, currentDifficulty.pairs);
            cards = [...currentThemeEmojis, ...currentThemeEmojis];
            
            flippedCards = [];
            matchedPairs = 0;
            moves = 0;
            movesCountSpan.textContent = `步數: 0`;

            const selectedTime = timerSelect.value;
            if (selectedTime === 'unlimited') {
                isCountdown = false;
                seconds = 0;
                timerSpan.textContent = '時間: 0s';
            } else {
                isCountdown = true;
                seconds = parseInt(selectedTime, 10);
                timerSpan.textContent = `時間: ${seconds}s`;
            }

            [nameModal, leaderboardModal, loseModal].forEach(modal => modal.style.display = 'none');
            shuffle(cards);
            createBoard();
        }

        function activateGame() {
            if (gameActive) return;
            gameActive = true;
            lockBoard = false;
            [difficultySelect, themeSelect, timerSelect].forEach(sel => sel.disabled = true);
            timer = setInterval(updateTimer, 1000);
            restartBtn.textContent = '重新開始';
        }

        function createBoard() {
            const difficulty = difficultySelect.value;
            const currentDifficulty = difficultySettings[difficulty];
            gameBoard.style.gridTemplateColumns = `repeat(${currentDifficulty.cols}, 1fr)`;
            gameBoard.innerHTML = '';
            cards.forEach(emoji => {
                const cardElement = document.createElement('div');
                cardElement.classList.add('card');
                cardElement.dataset.emoji = emoji;
                cardElement.innerHTML = `
                    <div class="card-face card-front">?</div>
                    <div class="card-face card-back">${emoji}</div>`;
                cardElement.addEventListener('click', handleCardClick);
                gameBoard.appendChild(cardElement);
            });
        }
        
        function handleCardClick(event) {
            const clickedCard = event.currentTarget;
            if (lockBoard || clickedCard.classList.contains('flipped') || flippedCards.length >= 2) return;
            clickedCard.classList.add('flipped');
            flippedCards.push(clickedCard);
            if (flippedCards.length === 2) {
                incrementMoves();
                checkForMatch();
            }
        }
        
        function checkForMatch() {
            lockBoard = true;
            const [card1, card2] = flippedCards;
            if (card1.dataset.emoji === card2.dataset.emoji) {
                setTimeout(() => {
                    card1.classList.add('matched');
                    card2.classList.add('matched');
                    matchedPairs++;
                    resetTurn();
                    const currentDifficulty = difficultySettings[difficultySelect.value];
                    if (matchedPairs === currentDifficulty.pairs) endGame();
                }, 500);
            } else {
                setTimeout(() => {
                    card1.classList.remove('flipped');
                    card2.classList.remove('flipped');
                    resetTurn();
                }, 1000);
            }
        }

        function resetTurn() {
            flippedCards = [];
            lockBoard = false;
        }

        function incrementMoves() {
            moves++;
            movesCountSpan.textContent = `步數: ${moves}`;
        }

        function updateTimer() {
            if (isCountdown) {
                seconds--;
                if (seconds <= 0) {
                    timerSpan.textContent = '時間: 0s';
                    gameOver();
                    return;
                }
            } else {
                seconds++;
            }
            timerSpan.textContent = `時間: ${seconds}s`;
        }
        
        function calculateScore() {
            const difficulty = difficultySelect.value;
            const baseScore = difficultySettings[difficulty].score;
            let score = 0;
            if (isCountdown) {
                // 倒數模式：剩餘時間有加成
                score = baseScore + (seconds * 20) - (moves * 10);
            } else {
                // 無限模式：時間和步數都是扣分項
                score = baseScore - (seconds * 5) - (moves * 15);
            }
            return Math.max(0, score); // 分數不能是負數
        }

        function endGame() {
            clearInterval(timer);
            gameActive = false;
            finalScore = calculateScore();
            finalScoreP.textContent = `您的最終分數: ${finalScore}`;
            nameModal.style.display = 'flex';
        }

        function gameOver() {
            clearInterval(timer);
            lockBoard = true;
            gameActive = false;
            loseModal.style.display = 'flex';
        }
        
        function getLeaderboard() {
            return JSON.parse(localStorage.getItem(LEADERBOARD_KEY)) || [];
        }

        function saveToLeaderboard(entry) {
            const leaderboard = getLeaderboard();
            leaderboard.push(entry);
            leaderboard.sort((a, b) => b.score - a.score); // 分數由高到低排序
            const top10 = leaderboard.slice(0, 10);
            localStorage.setItem(LEADERBOARD_KEY, JSON.stringify(top10));
        }
        
        function displayLeaderboard() {
            const leaderboard = getLeaderboard();
            leaderboardBody.innerHTML = ''; // 清空舊的列表
            if(leaderboard.length === 0) {
                 leaderboardBody.innerHTML = `<tr><td colspan="4">目前尚無紀錄</td></tr>`;
            } else {
                leaderboard.forEach((entry, index) => {
                    const row = document.createElement('tr');
                    const difficultyMap = { easy: '簡單', medium: '中等', hard: '困難' };
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${entry.name}</td>
                        <td>${entry.score}</td>
                        <td>${difficultyMap[entry.difficulty]}</td>
                    `;
                    leaderboardBody.appendChild(row);
                });
            }
            leaderboardModal.style.display = 'flex';
        }

        // --- 事件監聽 ---
        restartBtn.addEventListener('click', () => {
            if (!gameActive) activateGame();
            else prepareGame();
        });
        
        submitScoreBtn.addEventListener('click', () => {
            const name = playerNameInput.value.trim();
            if (name) {
                const entry = {
                    name: name,
                    score: finalScore,
                    difficulty: difficultySelect.value
                };
                saveToLeaderboard(entry);
                playerNameInput.value = '';
                nameModal.style.display = 'none';
                displayLeaderboard();
            } else {
                alert('請輸入您的名稱！');
            }
        });

        leaderboardBtn.addEventListener('click', displayLeaderboard);
        closeLeaderboardBtn.addEventListener('click', () => {
            leaderboardModal.style.display = 'none';
            prepareGame(); // 關閉排行榜後重置遊戲
        });
        modalTryAgainBtn.addEventListener('click', prepareGame);

        [difficultySelect, themeSelect, timerSelect].forEach(sel => sel.addEventListener('change', prepareGame));
        document.addEventListener('DOMContentLoaded', prepareGame);
    </script>
</body>
</html>

